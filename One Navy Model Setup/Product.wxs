<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductName = "ESME Workbench" ?>
  <?define ProductVersion = "1.0" ?>
  <?define ProductFullVersion = "1.0.0.0" ?>
  <?define ProductAuthor = "Hearing Research Center" ?>
  <?define Manufacturer="Boston University"?>
  <?define ProductAppFolder = "InstallLocation" ?>
  <?define ESMERoot="C:\Projects\ESME Deliverables"?>
  <?define ESMEPath="$(var.ESMERoot)\ESME WorkBench\bin\Release"?>
  <?define HDFPath="$(var.ESMERoot)\Libraries\ESME\External References"?>
  <?define ESMEViewsPath="$(var.ESMERoot)\ESME.Controls\bin\Release"?>
  <?define BellhopPath="$(var.ESMERoot)\Utilities\bellhop"?>
  <?define MMMBSPath="$(var.ESMERoot)\Utilities\3MB"?>
  <?define MergeModulesPath="C:\Program Files (x86)\Common Files\Merge Modules"?>
  <?define ReleaseNotesPath="$(var.ESMERoot)\Release Notes"?>
  <?define TransmissionLossViewerPath="$(var.ESMERoot)\TransmissionLossViewer\bin\Release"?>
  <?define TransmissionLossCalculatorPath="$(var.ESMERoot)\TransmissionLossCalculator\bin\Release"?>

  <?if $(var.Platform) = x64 ?>
  <?define ProductDisplayName = "$(var.ProductName) 64-bit" ?>
  <?define ProductId = "ECB254FD-4DD4-444B-8630-544A7DD71C56" ?>
  <?define ProductUpgradeCode = "88D30D04-AD51-4627-98E8-A54D82F8D4FC" ?>
  <?define Win64 = "yes" ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else ?>
  <?define ProductDisplayName = "$(var.ProductName)" ?>
  <?define ProductId = "62F4B20F-2E08-4EA1-A688-BDE8FE8653DB" ?>
  <?define ProductUpgradeCode = "12E20F8D-0C6D-47C9-98A1-D4920B755766" ?>
  <?define Win64 = "no" ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif ?>	
  <Product Id="$(var.ProductId)"
           Name="$(var.ProductDisplayName) (v$(var.ProductVersion))"
           Language="1033"
           Version="$(var.ProductFullVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.ProductUpgradeCode)">
    <Package InstallerVersion="300"
             Compressed="yes"
             InstallScope="perMachine"
             Manufacturer="$(var.ProductAuthor)"
             Platform="$(var.Platform)" />

    <Media Id="1"
           Cabinet="media.cab"
           EmbedCab="yes" />

    <WixVariable Id="WixUIBannerBmp" Value="Bitmaps\bannrbmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="Bitmaps\dlgbmp.bmp" />

    <MajorUpgrade AllowDowngrades="no"
                  AllowSameVersionUpgrades="yes"
                  Schedule="afterInstallFinalize"
                  MigrateFeatures="yes"
                  DowngradeErrorMessage="A later or current version of [ProductName] is already installed. To install this version, uninstall the installed version first." />

    <!-- Property gets value from registry to set up installation folder for upgrades -->
    <Property Id="APPLICATIONFOLDER" Secure="yes">
      <RegistrySearch Id='AppFolderRegistrySearch'
                      Type='raw'
                      Root='HKLM'
                      Key='Software\Microsoft\Windows\CurrentVersion\Uninstall\[WIX_UPGRADE_DETECTED]'
                      Name='$(var.ProductAppFolder)'
                      Win64='$(var.Win64)' />
    </Property>

    <!-- Define destination folder (name of app folder only) -->
    <Property Id="ApplicationFolderName" Value="$(var.ProductName)" />

    <!-- Default to per-machine installation -->
    <Property Id="WixAppFolder" Value="WixPerMachineFolder" />

    <!-- To disable per-user installation scope, uncomment this section
	  <WixVariable Id="WixUISupportPerUser" Value="0" />
  	-->

    <Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="$(var.PlatformProgramFilesFolder)">
				<Directory Id="APPLICATIONFOLDER" Name="$(var.ProductName)">
          <Component Id="ESMEWorkbench" 
                     Guid="68DE95CE-83D4-4BC0-8AB9-423655AEC06C"
                     Win64="$(var.Win64)">
            <ProgId Id="ESMEWorkbench.binfile" Description="CASS binary output file" Icon="TransmissionLossViewer.exe" IconIndex="1">
              <Extension Id="bin" ContentType="application/cass">
                <Verb Id="open" Command="Open" TargetFile="TransmissionLossViewer.exe" Argument='"%1"'/>
              </Extension>
            </ProgId>
            <!-- Core ESME executables and assemblies -->
            <File Id="ESMEWorkBench.exe"
                  Name="ESMEWorkBench.exe"
                  Source="$(var.ESMEPath)\ESMEWorkBench.exe"
                  KeyPath="yes"/>
            <File Id="ESMEWorkBench.exe.config"
                  Name="ESMEWorkBench.exe.config"
                  Source="$(var.ESMEPath)\ESMEWorkBench.exe.config" />
            <File Id="ESME.dll"
                  Name="ESME.dll"
                  Source="$(var.ESMEPath)\ESME.dll" />
            <File Id="ESME.Views.dll"
                  Name="ESME.Views.dll"
                  Source="$(var.ESMEViewsPath)\ESME.Views.dll" />
            <File Id="HRC.dll"
                  Name="HRC.dll"
                  Source="$(var.ESMEPath)\HRC.dll" />
            <File Id="ReleaseNotes"
                  Name="ESME Workbench Release Notes.pdf"
                  Source="$(var.ReleaseNotesPath)\ESME Workbench Release Notes.pdf" />
            <File Id="UserManual"
                  Name="ESME Workbench User Manual V1.pdf"
                  Source="$(var.ReleaseNotesPath)\ESME Workbench User Manual V1.pdf" />
            <File Id="UserGuide"
                  Name="ESME Workbench User Guide.pdf"
                  Source="$(var.ReleaseNotesPath)\ESME Workbench User Guide.pdf" />
            <File Id="ReadMe"
                  Name="Read Me.pdf"
                  Source="$(var.ReleaseNotesPath)\Read Me.pdf" />
            <File Id="TransmissionLossCalculator.exe"
                  Name="TransmissionLossCalculator.exe"
                  Source="$(var.TransmissionLossCalculatorPath)\TransmissionLossCalculator.exe" />
            <File Id="TransmissionLossViewer.exe"
                  Name="TransmissionLossViewer.exe"
                  Source="$(var.TransmissionLossViewerPath)\TransmissionLossViewer.exe" />
            <File Id="WebsiteLink"
                  Name="ESME.url"
                  Source="$(var.ESMERoot)\ESME.url" />

            <!-- Bellhop acoustic simulator -->
            <File Id="cyggcc_s1.dll"
                  Name="cyggcc_s-1.dll"
                  Source="$(var.BellhopPath)\cyggcc_s-1.dll" />
            <File Id="cyggfortran3.dll"
                  Name="cyggfortran-3.dll"
                  Source="$(var.BellhopPath)\cyggfortran-3.dll" />
            <File Id="cygwin1.dll"
                  Name="cygwin1.dll"
                  Source="$(var.BellhopPath)\cygwin1.dll" />
            <File Id="bellhop.exe"
                  Name="bellhop.exe"
                  Source="$(var.BellhopPath)\bellhop.exe" />
            <!-- End external executables -->

            <!-- ThinkGeo GIS assemblies -->
            <File Id="MapSuiteCore.dll"
                  Name="MapSuiteCore.dll"
                  Source="$(var.ESMEPath)\MapSuiteCore.dll" />
            <File Id="NetTopologySuite.dll"
                  Name="NetTopologySuite.dll"
                  Source="$(var.ESMEPath)\NetTopologySuite.dll" />
            <File Id="GeoAPI.dll"
                  Name="GeoAPI.dll"
                  Source="$(var.ESMEPath)\GeoAPI.dll" />
            <File Id="WpfDesktopEdition.dll"
                  Name="WpfDesktopEdition.dll"
                  Source="$(var.ESMEPath)\WpfDesktopEdition.dll" />

            <!-- HDF5 assemblies and other DLLs -->
            <File Id="hdf5_hldll.dll"
                  Name="hdf5_hldll.dll"
                  Source="$(var.HDFPath)\hdf5_hldll.dll" />
            <File Id="hdf5dll.dll"
                  Name="hdf5dll.dll"
                  Source="$(var.HDFPath)\hdf5dll.dll" />
            <File Id="HDF5DotNet.dll"
                  Name="HDF5DotNet.dll"
                  Source="$(var.HDFPath)\HDF5DotNet.dll" />
            <File Id="szip.dll"
                  Name="szip.dll"
                  Source="$(var.HDFPath)\szip.dll" />
            <File Id="zlib1.dll"
                  Name="zlib1.dll"
                  Source="$(var.HDFPath)\zlib1.dll" />

            <!-- MVVM assemblies -->
            <File Id="Cinch.WPF.dll"
                  Name="Cinch.WPF.dll"
                  Source="$(var.ESMEPath)\Cinch.WPF.dll" />
            <File Id="MEFedMVVM.WPF.dll"
                  Name="MEFedMVVM.WPF.dll"
                  Source="$(var.ESMEPath)\MEFedMVVM.WPF.dll" />

            <!-- C5 assembly -->
            <File Id="C5.dll"
                  Name="C5.dll"
                  Source="$(var.ESMEPath)\C5.dll" />

            <!-- Miscellaneous assemblies -->
            <File Id="Kent.Boogaart.Converters.dll"
                  Name="Kent.Boogaart.Converters.dll"
                  Source="$(var.ESMEPath)\Kent.Boogaart.Converters.dll" />
            <File Id="Kent.Boogaart.HelperTrinity.dll"
                  Name="Kent.Boogaart.HelperTrinity.dll"
                  Source="$(var.ESMEPath)\Kent.Boogaart.HelperTrinity.dll" />
            <File Id="AsyncCtpLibrary.dll"
                  Name="AsyncCtpLibrary.dll"
                  Source="$(var.ESMEPath)\AsyncCtpLibrary.dll" />
            <File Id="System.Threading.Tasks.Dataflow.dll"
                  Name="System.Threading.Tasks.Dataflow.dll"
                  Source="$(var.ESMEPath)\System.Threading.Tasks.Dataflow.dll" />
            <File Id="System.Data.SQLite.dll"
                  Name="System.Data.SQLite.dll"
                  Source="$(var.ESMEPath)\System.Data.SQLite.dll" />
            <File Id="System.Data.SQLite.Linq.dll"
                  Name="System.Data.SQLite.dllSystem.Data.SQLite.Linq.dll"
                  Source="$(var.ESMEPath)\System.Data.SQLite.Linq.dll" />

            <!-- 3MB assemblies -->
            <File Id="MMMBSLib.dll"
                  Name="3MBSLib.dll"
                  Source="$(var.MMMBSPath)\3MBSLib.dll" />
            <File Id="MMMBWrapperClass.dll"
                  Name="3MBWrapperClass.dll"
                  Source="$(var.MMMBSPath)\3MBWrapperClass.dll" />
            <File Id="MMMB.exe"
                  Name="3MB.exe"
                  Source="$(var.MMMBSPath)\3MB.exe" />
            <File Id="MMMBSpeciesBuilder.exe"
                  Name="3mbSpeciesBuilder.exe"
                  Source="$(var.MMMBSPath)\3mbSpeciesBuilder.exe" />

            <!-- Miscellaneous Microsoft assemblies -->
            <File Id="Microsoft.Expression.InteractionsDLL"
                  Name="Microsoft.Expression.Interactions.dll"
                  Source="$(var.ESMEPath)\Microsoft.Expression.Interactions.dll" />
            <File Id="System.Windows.Interactivity.dll"
                  Name="System.Windows.Interactivity.dll"
                  Source="$(var.ESMEPath)\System.Windows.Interactivity.dll" />
            <File Id="Microsoft.Windows.Shell.dll"
                  Name="Microsoft.Windows.Shell.dll"
                  Source="$(var.ESMEPath)\Microsoft.Windows.Shell.dll" />

            <!-- Microsoft Ribbon assembly -->
            <File Id="RibbonControlsLibrary.dll"
                  Name="RibbonControlsLibrary.dll"
                  Source="$(var.ESMEPath)\RibbonControlsLibrary.dll" />
          </Component>
          <?if $(var.Platform) = x64 ?>
          <!-- 64-bit components go here -->
            <Merge Id="vc100" Language="1033" SourceFile="$(var.MergeModulesPath)\Microsoft_VC100_CRT_x64.msm" DiskId="1" />
          <?else ?>
          <!-- 32-bit components go here -->
            <Merge Id="vc100" Language="1033" SourceFile="$(var.MergeModulesPath)\Microsoft_VC100_CRT_x86.msm" DiskId="1" />
          <?endif ?>
          <Component Id="ESMEWorkbench_Shortcuts" 
                     Guid="C7CC0E54-2890-4685-AC04-815E87C878A8"
                     Win64="$(var.Win64)">
            <RegistryKey Root="HKCU" Key="Software\[Manufacturer]\[ProductName]">
              <RegistryValue Value="Uninstall" Type="string" KeyPath="yes" />
            </RegistryKey>
            <Shortcut Id="ESMEWorkbench_Program_Group_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="$(var.ProductName)"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESMEWorkBench.exe"
                      Advertise="no" />
            <Shortcut Id="TransmissionLossViewer_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="Transmission Loss Viewer"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]TransmissionLossViewer.exe"
                      Advertise="no" />
            <Shortcut Id="ReleaseNotes_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="Release Notes"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESME Workbench Release Notes.pdf"
                      Advertise="no" />
            <Shortcut Id="UserGuide_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="User Guide"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESME Workbench User Guide.pdf"
                      Advertise="no" />
            <Shortcut Id="UserManual_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="User Manual"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESME Workbench User Manual V1.pdf"
                      Advertise="no" />
            <Shortcut Id="ReadMe_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="Read Me"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]Read Me.pdf"
                      Advertise="no" />
            <Shortcut Id="WebLink_Shortcut"
                      Directory="ProgramMenuDir"
                      Name="Visit the ESME Workbench Website to download environmental data"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESME.url"
                      Advertise="no" />
            <Shortcut Id="ESMEWorkbench_Desktop_Shortcut"
                      Directory="DesktopFolder"
                      Name="$(var.ProductName)"
                      WorkingDirectory="APPLICATIONFOLDER"
                      Target="[APPLICATIONFOLDER]ESMEWorkBench.exe"
                      Advertise="no" />
            <Shortcut Id="UninstallProduct"
                      Directory="ProgramMenuDir"
                      Advertise="no"
                      Name="Uninstall $(var.ProductName)"
                      WorkingDirectory="INSTALLDIR"
                      Target="[SystemFolder]msiexec.exe"
                      Arguments="/x [ProductCode]"
                      Description="Uninstalls $(var.ProductName)" />
            <RemoveFolder Id="DeleteShortcutFolder"
                          Directory="ProgramMenuDir"
                          On="uninstall" />
          </Component>
          <Directory Id="GISDataFolder" Name="Sample GIS Data">
            <Component Id="GISFiles" 
                       Guid="22C39901-AC58-4461-8BAF-15616C48649D"
                       Win64="$(var.Win64)">
              <File Id="Countries02.shx"
                    Name="Countries02.shx"
                    Source="$(var.ESMEPath)\Sample GIS Data\Countries02.shx"
                    KeyPath="yes" />
              <File Id="Countries02.dbf"
                    Name="Countries02.dbf"
                    Source="$(var.ESMEPath)\Sample GIS Data\Countries02.dbf" />
              <File Id="Countries02.ids"
                    Name="Countries02.ids"
                    Source="$(var.ESMEPath)\Sample GIS Data\Countries02.ids" />
              <File Id="Countries02.idx"
                    Name="Countries02.idx"
                    Source="$(var.ESMEPath)\Sample GIS Data\Countries02.idx" />
              <File Id="Countries02.shp"
                    Name="Countries02.shp"
                    Source="$(var.ESMEPath)\Sample GIS Data\Countries02.shp" />
            </Component>
          </Directory>
        </Directory>
			</Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuDir" Name="$(var.ProductName)"/>
      </Directory>
    </Directory>
    <Feature Id="ProductFeature" Title="ESME Workbench" Level="1" ConfigurableDirectory="TARGETDIR">
      <ComponentRef Id="ESMEWorkbench" />
      <MergeRef Id="vc100"/>
      <ComponentRef Id="GISFiles" />
      <ComponentRef Id="ESMEWorkbench_Shortcuts"/>
    </Feature>

    <!-- 
		Set default destination folder (full path) unless it comes from registry 
		SetDirectory schedules the action prior to WixSetDefaultPerMachineFolder;
		code updated for manually scheduled elements to schedule between 
		WixSetDefaultPerMachineFolder and WixSetPerMachineFolder.
	-->
    <SetDirectory
      Id="APPLICATIONFOLDER"
      Value="[$(var.PlatformProgramFilesFolder)][ApplicationFolderName]">APPLICATIONFOLDER=""</SetDirectory>

    <CustomAction
        Id="OverwriteWixSetDefaultPerMachineFolder"
        Property="WixPerMachineFolder"
        Value="[APPLICATIONFOLDER]"
        Execute="immediate"
	/>

    <!-- Save destination folder in Add/Remove programs (ARP) registry key -->
    <SetProperty
      Id="ARPINSTALLLOCATION"
      Value="[APPLICATIONFOLDER]"
      After="CostFinalize"
	/>

    <InstallUISequence>
      <!-- Corrects WixUI_Advanced bug (http://bit.ly/hrbM7Y) -->
      <Custom Action="OverwriteWixSetDefaultPerMachineFolder" After="WixSetDefaultPerMachineFolder" />
    </InstallUISequence>

    <InstallExecuteSequence>
      <!-- Corrects WixUI_Advanced bug (http://bit.ly/hrbM7Y) -->
      <Custom Action="OverwriteWixSetDefaultPerMachineFolder" After="WixSetDefaultPerMachineFolder" />

      <!-- Do not delete Windows service configuration on upgrade -->
      <DeleteServices>NOT UPGRADINGPRODUCTCODE</DeleteServices>
    </InstallExecuteSequence>

    <!-- Setup wizard sequence -->
    <UI Id="UISequence">
      <UIRef Id="WixUI_Advanced"/>
    </UI>
  </Product>
</Wix>
